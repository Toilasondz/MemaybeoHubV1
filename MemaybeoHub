--== PC RBLX v2.6 - Fix Menu Ẩn Mặc Định & Sửa Tên Nút ==--

local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")
local Lighting = game:GetService("Lighting") 
local TweenService = game:GetService("TweenService") 

local LocalPlayer = Players.LocalPlayer
local Character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait() 
local Camera = Workspace.CurrentCamera
local Mouse = LocalPlayer:GetMouse()
local PlayerGui = LocalPlayer:WaitForChild("PlayerGui")

-- TRẠNG THÁI TÍNH NĂNG
local AIMBOT_ENABLED = false
local ESP_ENABLED = false
local ESPLINE_ENABLED = false
local FOV_ENABLED = false
local TEAMCHECK_ENABLED = false
local GUI_CLOSED = false 

--== CÀI ĐẶT MÀU SẮC ==--
local ENEMY_COLOR = Color3.fromRGB(255, 255, 255)     -- TRẮNG (Cho ESP Box và Line)
local TEAM_COLOR = Color3.fromRGB(0, 255, 0)         -- XANH LÁ
local FOV_COLOR = Color3.fromRGB(0, 255, 0)          -- XANH LÁ CÂY 
local INDEX_COLOR_ENEMY = Color3.fromRGB(255, 0, 0)  -- ĐỎ (Cho Index Text của Enemy)

--== GUI & DRAWING DEFINITIONS ==--
local ScreenGui, Frame, ToggleBtn
local BtnToggleAimbot, BtnToggleESP, BtnToggleESPLines, BtnToggleFOV, BtnToggleTeamCheck, CloseBtn
local CustomCopyBtn 
local Notification
local PlayerCountLabel 
local FPSMover 

--== FOV SETUP ==--
local fovCircle
do
    local success, circle = pcall(function() return Drawing.new("Circle") end)
    if success and circle then
        fovCircle = circle
        fovCircle.Visible = false
        fovCircle.Radius = 90
        fovCircle.Thickness = 2
        fovCircle.Color = FOV_COLOR
        fovCircle.Filled = false
    else
        fovCircle = nil
    end
end

--== ESP SETUP ==--
local ESPs = {}

local function createESP(plr)
    if not plr or plr == LocalPlayer then return end
    if ESPs[plr] then return end

    local successBox, box = pcall(function() return Drawing.new("Square") end)
    local successLine, line = pcall(function() return Drawing.new("Line") end)
    local successText, text = pcall(function() return Drawing.new("Text") end) 
    
    ESPs[plr] = {
        Box = successBox and box or nil,
        Line = successLine and line or nil,
        IndexText = successText and text or nil
    }

    if ESPs[plr].Box then
        ESPs[plr].Box.Visible = false
        ESPs[plr].Box.Thickness = 1
        ESPs[plr].Box.Filled = false
        ESPs[plr].Box.Color = ENEMY_COLOR -- TRẮNG
    end
    if ESPs[plr].Line then
        ESPs[plr].Line.Visible = false
        ESPs[plr].Line.Thickness = 1
        ESPs[plr].Line.Color = ENEMY_COLOR -- TRẮNG
    end
    if ESPs[plr].IndexText then 
        ESPs[plr].IndexText.Visible = false
        ESPs[plr].IndexText.Size = 36 -- KÍCH THƯỚC LỚN HƠN
        ESPs[plr].IndexText.Outline = true
        ESPs[plr].IndexText.Color = ENEMY_COLOR 
    end
end

for _, p in ipairs(Players:GetPlayers()) do
    createESP(p)
end
Players.PlayerAdded:Connect(createESP)
Players.PlayerRemoving:Connect(function(plr)
    local data = ESPs[plr]
    if data then
        if data.Box then pcall(function() data.Box:Remove() end) end
        if data.Line then pcall(function() data.Line:Remove() end) end
        if data.IndexText then pcall(function() data.IndexText:Remove() end) end
        ESPs[plr] = nil
    end
end)

-- [Core Functions: isVisible, getClosestToFOV, ToggleBlur, showNotification]

local function isVisible(part)
    if not part then return false end
    local origin = Camera and Camera.CFrame.Position or Workspace.CurrentCamera.CFrame.Position
    local dir = (part.Position - origin)
    if dir.Magnitude == 0 then return true end
    local ray = Ray.new(origin, dir.Unit * math.clamp(dir.Magnitude, 1, 1000))
    local hit, hitPos = Workspace:FindPartOnRay(ray, LocalPlayer.Character, false, true)
    return hit and hit:IsDescendantOf(part.Parent)
end

local function getClosestToFOV()
    if not AIMBOT_ENABLED then return nil end
    local closest, dist = nil, math.huge
    for _, plr in pairs(Players:GetPlayers()) do
        if plr ~= LocalPlayer and plr.Character and plr.Character:FindFirstChild("Head") then
            if TEAMCHECK_ENABLED and plr.Team and LocalPlayer.Team and plr.Team == LocalPlayer.Team then
                continue
            end
            local head = plr.Character.Head
            local vec, onScreen = Camera:WorldToViewportPoint(head.Position)
            if onScreen then
                local mag = (Vector2.new(vec.X, vec.Y) - Vector2.new(Camera.ViewportSize.X/2, Camera.ViewportSize.Y/2)).Magnitude
                if mag < (fovCircle and fovCircle.Radius or 90) and mag < dist then
                    if isVisible(head) then
                        closest = head
                        dist = mag
                    end
                end
            end
        end
    end
    return closest
end

local blur = Instance.new("BlurEffect")
blur.Size = 0
blur.Parent = Lighting

local function ToggleBlur(state)
    TweenService:Create(
        blur,
        TweenInfo.new(0.35, Enum.EasingStyle.Sine, Enum.EasingDirection.Out),
        {Size = state and 14 or 0}
    ):Play()
end

function showNotification(msg)
    if GUI_CLOSED then return end
    if not Notification or not Notification.Parent then pcall(buildGUI) end
    if not Notification then return end
    Notification.Text = msg
    Notification.Visible = true
    task.delay(2, function()
        if Notification then Notification.Visible = false end
    end)
end

--== GUI BUILDER FUNCTION ==--
local function buildGUI()
    if ScreenGui and ScreenGui.Parent then 
        if not ToggleBtn.Parent then ToggleBtn.Parent = ScreenGui end
        if not FPSMover.Parent then FPSMover.Parent = ScreenGui end 
        return 
    end
    
    ScreenGui = Instance.new("ScreenGui")
    ScreenGui.Name = "MeMayBeo Hub"
    ScreenGui.ResetOnSpawn = false

    -- 0. FPS MOVER (NEW: Phần tử độc lập, có thể kéo thả)
    FPSMover = Instance.new("TextLabel", ScreenGui)
    FPSMover.Size = UDim2.new(0, 80, 0, 20) 
    FPSMover.Position = UDim2.new(1, -90, 0, 10) -- Góc trên bên phải
    FPSMover.BackgroundTransparency = 0.8
    FPSMover.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
    FPSMover.Text = "[FPS: N/A]"
    FPSMover.TextColor3 = Color3.fromRGB(255, 255, 255)
    FPSMover.Font = Enum.Font.SourceSansBold
    FPSMover.TextSize = 14
    FPSMover.Active = true
    FPSMover.Draggable = true 

    local fpsCorner = Instance.new("UICorner", FPSMover)
    fpsCorner.CornerRadius = UDim.new(0, 5)

    -- 1. NÚT MỞ/ĐÓNG MENU (ToggleBtn)
    ToggleBtn = Instance.new("TextButton", ScreenGui)
    ToggleBtn.Size = UDim2.new(0, 30, 0, 30)
    ToggleBtn.Position = UDim2.new(0, 10, 0, 10) 
    ToggleBtn.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
    ToggleBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
    ToggleBtn.Font = Enum.Font.SourceSansBold
    ToggleBtn.TextSize = 20
    ToggleBtn.Text = "㊎" 
    
    local cornerToggle = Instance.new("UICorner", ToggleBtn)
    cornerToggle.CornerRadius = UDim.new(0, 5) 

    -- Logic Kéo thả cho ToggleBtn
    local draggingBtn = false
    local dragStartBtn
    local startPosBtn

    ToggleBtn.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            draggingBtn = true
            dragStartBtn = input.Position
            startPosBtn = ToggleBtn.Position
        end
    end)
    ToggleBtn.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            draggingBtn = false
        end
    end)
    UserInputService.InputChanged:Connect(function(input)
        if draggingBtn and input.UserInputType == Enum.UserInputType.MouseMovement then
            local delta = input.Position - dragStartBtn
            ToggleBtn.Position = UDim2.new(
                startPosBtn.X.Scale,
                startPosBtn.X.Offset + delta.X,
                startPosBtn.Y.Scale,
                startPosBtn.Y.Offset + delta.Y
            )
        end
    end)


    -- 2. FRAME CHÍNH (Menu) 
    Frame = Instance.new("Frame", ScreenGui)
    Frame.Size = UDim2.new(0, 240, 0, 380) 
    Frame.Position = UDim2.new(0.5, -120, 0.5, -190) -- Căn giữa màn hình
    Frame.BackgroundColor3 = Color3.fromRGB(40,40,40)
    Frame.BackgroundTransparency = 0.25 
    Frame.Active = true
    Frame.Draggable = true
    Frame.Visible = false 

    local corner = Instance.new("UICorner", Frame)
    corner.CornerRadius = UDim.new(0, 14)

    local gradient = Instance.new("UIGradient", Frame)
    gradient.Color = ColorSequence.new{
        ColorSequenceKeypoint.new(0, Color3.fromRGB(40,40,40)),
        ColorSequenceKeypoint.new(1, Color3.fromRGB(25,25,25))
    }
    gradient.Transparency = NumberSequence.new{
        NumberSequenceKeypoint.new(0, 0.15),
        NumberSequenceKeypoint.new(1, 0.25)
    }

    local TitleBar = Instance.new("TextLabel", Frame)
    TitleBar.Size = UDim2.new(1, 0, 0, 40)
    TitleBar.BackgroundColor3 = Color3.fromRGB(25,25,25)
    TitleBar.Text = "MeMayBeo Hub (K HOẶC ㊎ ĐỂ ĐÓNG)"
    TitleBar.TextColor3 = Color3.fromRGB(255,255,255)
    TitleBar.Font = Enum.Font.SourceSansBold
    TitleBar.TextSize = 16 
    
    local InfoLabel1 = Instance.new("TextLabel", Frame)
    InfoLabel1.Size = UDim2.new(1, -20, 0, 20)
    InfoLabel1.Position = UDim2.new(0, 10, 0, 40) 
    InfoLabel1.BackgroundTransparency = 1
    InfoLabel1.Text = "Tik Tok @hoangvanson_9k"
    InfoLabel1.TextColor3 = Color3.fromRGB(200,200,200)
    InfoLabel1.Font = Enum.Font.SourceSansItalic
    InfoLabel1.TextSize = 14

    local InfoLabel2 = Instance.new("TextLabel", Frame)
    InfoLabel2.Size = UDim2.new(1, -20, 0, 20)
    InfoLabel2.Position = UDim2.new(0, 10, 0, 55) 
    InfoLabel2.BackgroundTransparency = 1
    InfoLabel2.Text = "MeMayBeo Hub by @hoangvanson_9k"
    InfoLabel2.TextColor3 = Color3.fromRGB(200,200,200)
    InfoLabel2.Font = Enum.Font.SourceSansItalic
    InfoLabel2.TextSize = 14
    
    PlayerCountLabel = Instance.new("TextLabel", Frame)
    PlayerCountLabel.Size = UDim2.new(1, -20, 0, 20)
    PlayerCountLabel.Position = UDim2.new(0, 10, 0, 75) 
    PlayerCountLabel.BackgroundTransparency = 1
    PlayerCountLabel.Text = "Players Scanned: 0"
    PlayerCountLabel.TextColor3 = Color3.fromRGB(255,255,255)
    PlayerCountLabel.Font = Enum.Font.SourceSansBold
    PlayerCountLabel.TextSize = 16


    local function createButton(text, posY, color)
        local btn = Instance.new("TextButton", Frame)
        btn.Size = UDim2.new(0,200,0,30)
        btn.Position = UDim2.new(0,20,0,posY)
        btn.Text = text
        btn.BackgroundColor3 = color or Color3.fromRGB(60,60,60)
        btn.TextColor3 = Color3.fromRGB(255,255,255)
        btn.Font = Enum.Font.SourceSansBold
        btn.TextSize = 16
        local btnCorner = Instance.new("UICorner", btn)
        btnCorner.CornerRadius = UDim.new(0, 8) 
        return btn
    end

    -- Sửa lại tên nút theo yêu cầu (ngắn gọn hơn)
    BtnToggleAimbot = createButton("Aimbot: OFF", 100) 
    BtnToggleESP = createButton("ESP: OFF", 140)
    BtnToggleESPLines = createButton("ESP Lines: OFF", 180)
    BtnToggleFOV = createButton("Show FOV: OFF", 220)
    BtnToggleTeamCheck = createButton("Team Check: OFF", 260)
    
    -- Sửa lại tên nút CLOSE theo yêu cầu (CLOSE)
    CloseBtn = createButton("CLOSE", 300, Color3.fromRGB(150,50,50)) 
    
    CustomCopyBtn = createButton("CLICK NẾU BẠN ĐẸP TRAI", 340, Color3.fromRGB(50, 150, 255))
    CustomCopyBtn.TextSize = 18 

    -- 3. NOTIFICATION
    Notification = Instance.new("TextLabel", ScreenGui)
    Notification.Size = UDim2.new(0,200,0,30)
    Notification.Position = UDim2.new(1,-210,1,-40)
    Notification.BackgroundTransparency = 0.3
    Notification.BackgroundColor3 = Color3.fromRGB(20,20,20)
    Notification.TextColor3 = Color3.fromRGB(255,255,255)
    Notification.TextScaled = true
    Notification.Visible = false

    -- [Event Handlers]
    ToggleBtn.MouseButton1Click:Connect(function()
        if GUI_CLOSED then return end
        Frame.Visible = not Frame.Visible
        ToggleBlur(Frame.Visible)
    end)

    CustomCopyBtn.MouseButton1Click:Connect(function()
        local textToCopy = "@hoangvanson_9k"
        local copySuccessful = false
        pcall(function() setclipboard(textToCopy) copySuccessful = true end)
        if copySuccessful then showNotification("ĐÃ COPY: " .. textToCopy) else showNotification("ĐÃ COPY: " .. textToCopy .. " (Thất bại)") end
    end)
    
    BtnToggleAimbot.MouseButton1Click:Connect(function()
        if GUI_CLOSED then return end
        AIMBOT_ENABLED = not AIMBOT_ENABLED
        -- Cập nhật text ngắn gọn
        BtnToggleAimbot.Text = "Aimbot: " .. (AIMBOT_ENABLED and "ON" or "OFF")
        showNotification(AIMBOT_ENABLED and "Aimbot Enabled (Phím E)" or "Aimbot Disabled")
    end)

    BtnToggleESP.MouseButton1Click:Connect(function()
        if GUI_CLOSED then return end
        ESP_ENABLED = not ESP_ENABLED
        -- Cập nhật text ngắn gọn
        BtnToggleESP.Text = "ESP: " .. (ESP_ENABLED and "ON" or "OFF")
    end)

    BtnToggleESPLines.MouseButton1Click:Connect(function()
        if GUI_CLOSED then return end
        ESPLINE_ENABLED = not ESPLINE_ENABLED
        -- Cập nhật text ngắn gọn
        BtnToggleESPLines.Text = "ESP Lines: " .. (ESPLINE_ENABLED and "ON" or "OFF")
    end)

    BtnToggleFOV.MouseButton1Click:Connect(function()
        if GUI_CLOSED then return end
        FOV_ENABLED = not FOV_ENABLED
        BtnToggleFOV.Text = "Show FOV: " .. (FOV_ENABLED and "ON" or "OFF")
    end)

    BtnToggleTeamCheck.MouseButton1Click:Connect(function()
        if GUI_CLOSED then return end
        TEAMCHECK_ENABLED = not TEAMCHECK_ENABLED
        BtnToggleTeamCheck.Text = "Team Check: " .. (TEAMCHECK_ENABLED and "ON" or "OFF")
    end)

    CloseBtn.MouseButton1Click:Connect(function()
        AIMBOT_ENABLED = false
        ESP_ENABLED = false
        ESPLINE_ENABLED = false
        FOV_ENABLED = false
        TEAMCHECK_ENABLED = false
        GUI_CLOSED = true
        ToggleBlur(false) 

        if Frame then Frame.Visible = false end
        if ScreenGui then ScreenGui.Enabled = false end 

        -- Xóa tất cả các đối tượng Drawing
        if fovCircle then fovCircle.Visible = false end
        for _, esp in pairs(ESPs) do
            if esp.Box then pcall(function() esp.Box:Remove() end) end
            if esp.Line then pcall(function() esp.Line:Remove() end) end
            if esp.IndexText then pcall(function() esp.IndexText:Remove() end) end
        end
    end)

    -- Đặt ScreenGui vào PlayerGui sau khi tất cả đã được thiết lập
    ScreenGui.Parent = PlayerGui
end

buildGUI()

--== INPUT & CHARACTER EVENTS ==--

UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if GUI_CLOSED then return end
    
    if not gameProcessed and input.KeyCode == Enum.KeyCode.E then
        AIMBOT_ENABLED = not AIMBOT_ENABLED
        if BtnToggleAimbot and BtnToggleAimbot.Parent then
            -- Cập nhật text ngắn gọn
            BtnToggleAimbot.Text = "Aimbot: " .. (AIMBOT_ENABLED and "ON" or "OFF")
        end
        showNotification(AIMBOT_ENABLED and "Aimbot Enabled (Phím E)" or "Aimbot Disabled")
    
    elseif not gameProcessed and input.KeyCode == Enum.KeyCode.K then
        if Frame then
            Frame.Visible = not Frame.Visible
            ToggleBlur(Frame.Visible)
        else
            pcall(buildGUI)
        end
    end
end)

LocalPlayer.CharacterAdded:Connect(function(char)
    task.wait(0.25)
    Camera = Workspace.CurrentCamera
    Mouse = LocalPlayer:GetMouse()
    PlayerGui = LocalPlayer:WaitForChild("PlayerGui")
    if not ScreenGui or not ScreenGui.Parent then
        pcall(buildGUI)
    else
        if ScreenGui.Parent ~= PlayerGui then
            ScreenGui.Parent = PlayerGui
        end
    end
end)

--== FPS COUNTER SETUP ==--
local lastTick = tick()
RunService.Heartbeat:Connect(function()
    local now = tick()
    local delta = now - lastTick
    lastTick = now
    local fps = math.round(1 / delta)

    if FPSMover and FPSMover.Parent then
        FPSMover.Text = "[FPS: " .. fps .. "]"
    end
end)

--== RENDER LOOP (CẬP NHẬT MÀU VÀ INDEX TEXT VỊ TRÍ) ==--

RunService.RenderStepped:Connect(function()
    if GUI_CLOSED then
        if fovCircle then fovCircle.Visible = false end
        return
    end

    local visiblePlayerCount = 0
    local playerIndex = 0 

    if fovCircle then
        if FOV_ENABLED and Camera then
            fovCircle.Position = Vector2.new(Camera.ViewportSize.X/2, Camera.ViewportSize.Y/2)
            fovCircle.Visible = true
        else
            fovCircle.Visible = false
        end
    end

    for plr, esp in pairs(ESPs) do
        local character = plr.Character
        local shouldShow = ESP_ENABLED or ESPLINE_ENABLED
        
        if esp and character and character:FindFirstChild("HumanoidRootPart") and Camera and shouldShow then
            local hrp = character.HumanoidRootPart
            local vec, onScreen = Camera:WorldToViewportPoint(hrp.Position)
            
            local current_color
            if TEAMCHECK_ENABLED and plr.Team and LocalPlayer.Team and plr.Team == LocalPlayer.Team then
                current_color = TEAM_COLOR
            else
                current_color = ENEMY_COLOR -- TRẮNG (Cho Box và Line)
            end

            if onScreen then
                visiblePlayerCount = visiblePlayerCount + 1
                playerIndex = playerIndex + 1

                -- ESP BOX
                local topVec = Camera:WorldToViewportPoint(hrp.Position + Vector3.new(0,3.5,0))
                local bottomVec = Camera:WorldToViewportPoint(hrp.Position - Vector3.new(0,3.5,0))
                local height = math.abs(topVec.Y - bottomVec.Y)
                
                if ESP_ENABLED then
                    if esp.Box then
                        esp.Box.Size = Vector2.new(height*0.6, height)
                        esp.Box.Position = Vector2.new(vec.X - esp.Box.Size.X/2, vec.Y - esp.Box.Size.Y/2)
                        esp.Box.Color = current_color -- TRẮNG
                        esp.Box.Visible = true
                    end
                else
                    if esp.Box then esp.Box.Visible = false end
                end

                -- ESP LINES
                if ESPLINE_ENABLED then
                    if esp.Line then
                        -- Gốc tia cố định ở giữa cạnh trên
                        esp.Line.From = Vector2.new(Camera.ViewportSize.X/2, 0)
                        esp.Line.To = Vector2.new(vec.X, vec.Y)
                        esp.Line.Color = current_color -- TRẮNG
                        esp.Line.Visible = true
                    end
                else
                    if esp.Line then esp.Line.Visible = false end
                end

                -- INDEX TEXT (Vị trí gốc của tia ESP)
                if ESPLINE_ENABLED and esp.IndexText then
                    local lineOriginX = Camera.ViewportSize.X/2
                    local lineOriginY = 0
                    
                    -- Xác định màu cho Index Text: ĐỎ nếu là enemy, Xanh lá nếu là team
                    local index_text_color = current_color
                    if current_color == ENEMY_COLOR then
                        index_text_color = INDEX_COLOR_ENEMY -- Sử dụng màu ĐỎ
                    end
                    
                    -- Đặt số thứ tự gần vị trí khởi nguồn tia (ở giữa trên cùng)
                    esp.IndexText.Position = Vector2.new(lineOriginX - 10, lineOriginY + 10) 
                    esp.IndexText.Text = tostring(playerIndex)
                    esp.IndexText.Color = index_text_color -- Sử dụng màu đã xác định (ĐỎ/Xanh Lá)
                    esp.IndexText.Visible = true
                else
                    if esp.IndexText then esp.IndexText.Visible = false end
                end

            else
                if esp.Box then esp.Box.Visible = false end
                if esp.Line then esp.Line.Visible = false end
                if esp.IndexText then esp.IndexText.Visible = false end
            end
        else
            if esp.Box then esp.Box.Visible = false end
            if esp.Line then esp.Line.Visible = false end
            if esp.IndexText then esp.IndexText.Visible = false end
        end
    end
    
    if PlayerCountLabel and Frame and Frame.Visible then
        PlayerCountLabel.Text = "Players Scanned: " .. visiblePlayerCount .. (shouldShow and "" or " (ESP OFF)")
    end

    if AIMBOT_ENABLED and Camera then
        local target = getClosestToFOV()
        if target then
            Camera.CFrame = CFrame.new(Camera.CFrame.Position, target.Position)
        end
    end
end)
