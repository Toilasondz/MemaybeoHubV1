--== HoangSon COMBINED GUI v1.0  ==--

local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")

local LocalPlayer = Players.LocalPlayer
local Camera = Workspace.CurrentCamera
local Mouse = LocalPlayer:GetMouse()
local PlayerGui = LocalPlayer:WaitForChild("PlayerGui")

--== STATES ==--
local AIMBOT_ENABLED = false
local ESP_ENABLED = false
local ESPLINE_ENABLED = false
local FOV_ENABLED = false
local TEAMCHECK_ENABLED = false
local GUI_CLOSED = false -- Now controls the main UI visibility

--== FOV CIRCLE (Still uses Drawing.new as it's not part of the main UI) ==--
local fovCircle
do
    local success, circle = pcall(function() return Drawing.new("Circle") end)
    if success and circle then
        fovCircle = circle
        fovCircle.Visible = false
        fovCircle.Radius = 90
        fovCircle.Thickness = 2
        fovCircle.Color = Color3.fromRGB(255,255,255)
        fovCircle.Filled = false
    else
        fovCircle = nil
    end
end

--== ESP SETUP (Still uses Drawing.new) ==--
local ESPs = {}

local function createESP(plr)
    if not plr or plr == LocalPlayer then return end
    if ESPs[plr] then return end

    local successBox, box = pcall(function() return Drawing.new("Square") end)
    local successLine, line = pcall(function() return Drawing.new("Line") end)
    ESPs[plr] = {
        Box = successBox and box or nil,
        Line = successLine and line or nil
    }

    if ESPs[plr].Box then
        ESPs[plr].Box.Visible = false
        ESPs[plr].Box.Thickness = 1
        ESPs[plr].Box.Filled = false
        ESPs[plr].Box.Color = Color3.fromRGB(255,0,0) -- Example color
    end
    if ESPs[plr].Line then
        ESPs[plr].Line.Visible = false
        ESPs[plr].Line.Thickness = 1
        ESPs[plr].Line.Color = Color3.fromRGB(0,255,0) -- Example color
    end
end

for _, p in ipairs(Players:GetPlayers()) do
    createESP(p)
end
Players.PlayerAdded:Connect(createESP)
Players.PlayerRemoving:Connect(function(plr)
    local data = ESPs[plr]
    if data then
        if data.Box then pcall(function() data.Box:Remove() end) end
        if data.Line then pcall(function() data.Line:Remove() end) end
        ESPs[plr] = nil
    end
end)

--== FUNCTIONS ==--
local function isVisible(part)
    if not part then return false end
    local origin = Camera and Camera.CFrame.Position or Workspace.CurrentCamera.CFrame.Position
    local dir = (part.Position - origin)
    if dir.Magnitude == 0 then return true end
    local ray = Ray.new(origin, dir.Unit * math.clamp(dir.Magnitude, 1, 1000))
    local hit, hitPos = Workspace:FindPartOnRay(ray, LocalPlayer.Character, false, true)
    return hit and hit:IsDescendantOf(part.Parent)
end

local function getClosestToFOV()
    if not AIMBOT_ENABLED then return nil end
    local closest, dist = nil, math.huge
    for _, plr in pairs(Players:GetPlayers()) do
        if plr ~= LocalPlayer and plr.Character and plr.Character:FindFirstChild("Head") then
            if TEAMCHECK_ENABLED and plr.Team and LocalPlayer.Team and plr.Team == LocalPlayer.Team then
                continue
            end
            local head = plr.Character.Head
            local vec, onScreen = Camera:WorldToViewportPoint(head.Position)
            if onScreen then
                local mag = (Vector2.new(vec.X, vec.Y) - Vector2.new(Camera.ViewportSize.X/2, Camera.ViewportSize.Y/2)).Magnitude
                if mag < (fovCircle and fovCircle.Radius or 90) and mag < dist then
                    if isVisible(head) then
                        closest = head
                        dist = mag
                    end
                end
            end
        end
    end
    return closest
end

--== KHANHLY UI LIBRARY ==--
local KhanhlyUI = {}

function KhanhlyUI:CreateWindow(title, version, backgroundImageId)
    local gui = Instance.new("ScreenGui", PlayerGui)
    gui.Name = "Khanhly_GUI"
    gui.ResetOnSpawn = false

    local backgroundFrame = Instance.new("Frame", gui)
    backgroundFrame.Size = UDim2.new(0, 700, 0, 450) -- Adjust size to fit Khanhly UI style
    backgroundFrame.Position = UDim2.new(0.5, -350, 0.5, -225) -- Center it
    backgroundFrame.BackgroundTransparency = 1
    backgroundFrame.Name = "BackgroundFrame"

    -- Main UI panel with background image
    local mainPanel = Instance.new("ImageLabel", backgroundFrame)
    mainPanel.Size = UDim2.new(1, 0, 1, 0)
    mainPanel.Position = UDim2.new(0, 0, 0, 0)
    mainPanel.Image = "rbxassetid://" .. tostring(backgroundImageId or 75824323818711) -- Use the provided image or a default
    mainPanel.ScaleType = Enum.ScaleType.Stretch
    mainPanel.BackgroundTransparency = 1
    mainPanel.ImageTransparency = 0.5 -- Slightly transparent to blend
    local cornerPanel = Instance.new("UICorner", mainPanel)
    cornerPanel.CornerRadius = UDim.new(0, 10)
    mainPanel.ClipsDescendants = true -- Important for corners and content

    -- Overlay for darker transparency over background image
    local overlayFrame = Instance.new("Frame", mainPanel)
    overlayFrame.Size = UDim2.new(1, 0, 1, 0)
    overlayFrame.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
    overlayFrame.BackgroundTransparency = 0.7 -- Adjust for desired darkness
    overlayFrame.ZIndex = 2

    -- Top Bar
    local topBar = Instance.new("Frame", mainPanel)
    topBar.Size = UDim2.new(1, 0, 0, 30)
    topBar.Position = UDim2.new(0, 0, 0, 0)
    topBar.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
    topBar.BackgroundTransparency = 0.3
    topBar.ZIndex = 3

    -- Title Label
    local titleLabel = Instance.new("TextLabel", topBar)
    titleLabel.Size = UDim2.new(0.5, 0, 1, 0)
    titleLabel.Position = UDim2.new(0, 10, 0, 0)
    titleLabel.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
    titleLabel.BackgroundTransparency = 1
    titleLabel.Text = title
    titleLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
    titleLabel.Font = Enum.Font.GothamBold
    titleLabel.TextSize = 18
    titleLabel.TextXAlignment = Enum.TextXAlignment.Left

    -- Version Label
    local versionLabel = Instance.new("TextLabel", topBar)
    versionLabel.Size = UDim2.new(0.2, 0, 1, 0)
    versionLabel.Position = UDim2.new(0.5, -10, 0, 0)
    versionLabel.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
    versionLabel.BackgroundTransparency = 1
    versionLabel.Text = version
    versionLabel.TextColor3 = Color3.fromRGB(150, 255, 150) -- Greenish color
    versionLabel.Font = Enum.Font.GothamBold
    versionLabel.TextSize = 14
    versionLabel.TextXAlignment = Enum.TextXAlignment.Right

    -- Minimize/Close Buttons (Placeholders for now)
    local minimizeButton = Instance.new("TextButton", topBar)
    minimizeButton.Size = UDim2.new(0, 25, 1, 0)
    minimizeButton.Position = UDim2.new(1, -60, 0, 0)
    minimizeButton.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
    minimizeButton.BackgroundTransparency = 0.7
    minimizeButton.Text = "â€”"
    minimizeButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    minimizeButton.Font = Enum.Font.SourceSans
    minimizeButton.TextSize = 18
    minimizeButton.ZIndex = 4
    minimizeButton.MouseButton1Click:Connect(function()
        mainPanel.Visible = not mainPanel.Visible
        GUI_CLOSED = not mainPanel.Visible
    end)

    local closeButton = Instance.new("TextButton", topBar)
    closeButton.Size = UDim2.new(0, 25, 1, 0)
    closeButton.Position = UDim2.new(1, -30, 0, 0)
    closeButton.BackgroundColor3 = Color3.fromRGB(255, 50, 50)
    closeButton.BackgroundTransparency = 0.7
    closeButton.Text = "X"
    closeButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    closeButton.Font = Enum.Font.SourceSans
    closeButton.TextSize = 18
    closeButton.ZIndex = 4
    closeButton.MouseButton1Click:Connect(function()
        mainPanel:Destroy()
        GUI_CLOSED = true
        if fovCircle then fovCircle.Visible = false end
        for _, espData in pairs(ESPs) do
            if espData.Box then espData.Box.Visible = false end
            if espData.Line then espData.Line.Visible = false end
        end
    end)

    -- Make draggable (Top Bar makes the whole panel draggable)
    local dragging, dragInput, dragStart, startPos
    local function update(input)
        local delta = input.Position - dragStart
        backgroundFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
    end
    topBar.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            dragStart = input.Position
            startPos = backgroundFrame.Position
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragging = false
                end
            end)
        end
    end)
    topBar.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement then
            dragInput = input
        end
    end)
    UserInputService.InputChanged:Connect(function(input)
        if input == dragInput and dragging then
            update(input)
        end
    end)

    -- Left Navigation Panel
    local navPanel = Instance.new("Frame", mainPanel)
    navPanel.Size = UDim2.new(0, 100, 1, -30) -- Height is full minus top bar
    navPanel.Position = UDim2.new(0, 0, 0, 30)
    navPanel.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    navPanel.BackgroundTransparency = 0.2
    navPanel.ZIndex = 3

    local navLayout = Instance.new("UIListLayout", navPanel)
    navLayout.Padding = UDim.new(0, 5)
    navLayout.FillDirection = Enum.FillDirection.Vertical
    navLayout.HorizontalAlignment = Enum.HorizontalAlignment.Center
    navLayout.VerticalAlignment = Enum.VerticalAlignment.Top
    navLayout.SortOrder = Enum.SortOrder.LayoutOrder

    local function createNavButton(text)
        local btn = Instance.new("TextButton", navPanel)
        btn.Size = UDim2.new(1, -10, 0, 30)
        btn.Position = UDim2.new(0, 5, 0, 0)
        btn.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
        btn.BackgroundTransparency = 0.5
        btn.Text = text
        btn.TextColor3 = Color3.fromRGB(255, 255, 255)
        btn.Font = Enum.Font.GothamBold
        btn.TextSize = 16
        local corner = Instance.new("UICorner", btn)
        corner.CornerRadius = UDim.new(0, 5)
        return btn
    end

    createNavButton("Main") -- Example nav button

    -- Main Content Panel
    local contentPanel = Instance.new("Frame", mainPanel)
    contentPanel.Size = UDim2.new(1, -100, 1, -30) -- Full width minus nav panel, full height minus top bar
    contentPanel.Position = UDim2.new(0, 100, 0, 30)
    contentPanel.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
    contentPanel.BackgroundTransparency = 0.8 -- Semi-transparent dark background
    contentPanel.ZIndex = 3
    local cornerContent = Instance.new("UICorner", contentPanel)
    cornerContent.CornerRadius = UDim.new(0, 10) -- Match outer panel's corner but for content frame

    local contentLayout = Instance.new("UIListLayout", contentPanel)
    contentLayout.Padding = UDim.new(0, 10)
    contentLayout.FillDirection = Enum.FillDirection.Vertical
    contentLayout.HorizontalAlignment = Enum.HorizontalAlignment.Left
    contentLayout.VerticalAlignment = Enum.VerticalAlignment.Top
    contentLayout.SortOrder = Enum.SortOrder.LayoutOrder
    contentLayout.Parent = contentPanel -- Ensure layout is parented

    -- Inner container for controls to respect padding
    local innerContent = Instance.new("Frame", contentPanel)
    innerContent.Size = UDim2.new(1, -20, 1, -20)
    innerContent.Position = UDim2.new(0, 10, 0, 10)
    innerContent.BackgroundTransparency = 1
    local innerContentLayout = Instance.new("UIListLayout", innerContent)
    innerContentLayout.Padding = UDim.new(0, 8)
    innerContentLayout.FillDirection = Enum.FillDirection.Vertical
    innerContentLayout.SortOrder = Enum.SortOrder.LayoutOrder


    function KhanhlyUI:CreateToggle(name, callback)
        local btnContainer = Instance.new("Frame", innerContent)
        btnContainer.Size = UDim2.new(1, 0, 0, 40) -- Height for toggle + label
        btnContainer.BackgroundTransparency = 1
        btnContainer.LayoutOrder = innerContentLayout.Parent.Children:GetChildren() and #innerContentLayout.Parent.Children:GetChildren() + 1 or 1

        local btn = Instance.new("TextButton", btnContainer)
        btn.Size = UDim2.new(0, 100, 1, -10) -- Example toggle button size
        btn.Position = UDim2.new(0, 0, 0, 0)
        btn.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
        btn.TextColor3 = Color3.new(1, 1, 1)
        btn.Font = Enum.Font.GothamBold
        btn.TextSize = 16
        btn.Text = name .. ": OFF"

        local cornerBtn = Instance.new("UICorner", btn)
        cornerBtn.CornerRadius = UDim.new(0, 7)

        local state = false
        btn.MouseButton1Click:Connect(function()
            state = not state
            btn.Text = name .. ": " .. (state and "ON" or "OFF")
            callback(state)
        end)
    end

    -- Return mainPanel to allow modification
    return {
        Panel = mainPanel,
        Content = innerContent,
        CreateToggle = function(name, callback) KhanhlyUI:CreateToggle(name, callback) end
    }
end

--== CREATE WINDOW + TOGGLES (using Khanhly UI style) ==--
-- Use the specific asset ID for the sunset classroom image: 9170251649
local KHANHLY_BG_IMAGE_ID = 9170251649 

local win = KhanhlyUI:CreateWindow("HoangSon", "v1")

win:CreateToggle("Aimbot", function(v) AIMBOT_ENABLED = v end)
win:CreateToggle("ESP", function(v) ESP_ENABLED = v end)
win:CreateToggle("ESP Lines", function(v) ESPLINE_ENABLED = v end)
win:CreateToggle("Show FOV", function(v) FOV_ENABLED = v end)
win:CreateToggle("Team Check", function(v) TEAMCHECK_ENABLED = v end)

--== RENDER LOGIC ==--
RunService.RenderStepped:Connect(function()
    -- Only manage `Drawing` objects here. The GUI visibility is handled by the close/minimize buttons.
    if GUI_CLOSED or not win.Panel.Visible then
        if fovCircle then fovCircle.Visible = false end
        for _, espData in pairs(ESPs) do
            if espData.Box then espData.Box.Visible = false end
            if espData.Line then espData.Line.Visible = false end
        end
        return
    end

    -- FOV Circle
    if fovCircle then
        if FOV_ENABLED and Camera then
            fovCircle.Position = Vector2.new(Camera.ViewportSize.X/2, Camera.ViewportSize.Y/2)
            fovCircle.Visible = true
        else
            fovCircle.Visible = false
        end
    end

    -- ESP
    for plr, esp in pairs(ESPs) do
        if esp and plr and plr.Character and plr.Character:FindFirstChild("HumanoidRootPart") and Camera then
            local hrp = plr.Character.HumanoidRootPart
            local head = plr.Character:FindFirstChild("Head") -- Also need head for visibility/aimbot
            
            -- Only show ESP if enabled and visible on screen
            local hrpVec, hrpOnScreen = Camera:WorldToViewportPoint(hrp.Position)
            if ESP_ENABLED and hrpOnScreen and head and isVisible(head) then -- Ensure ESP respects visibility check
                local topVec, topOnScreen = Camera:WorldToViewportPoint(hrp.Position + Vector3.new(0, 2.5, 0)) -- Slightly above HRP
                local bottomVec, bottomOnScreen = Camera:WorldToViewportPoint(hrp.Position - Vector3.new(0, 2.5, 0)) -- Slightly below HRP

                if topOnScreen and bottomOnScreen then
                    local height = math.abs(topVec.Y - bottomVec.Y)
                    local width = height * 0.6 -- Common aspect ratio for bounding boxes

                    -- ESP Box
                    if esp.Box then
                        esp.Box.Visible = true
                        esp.Box.Size = Vector2.new(width, height)
                        esp.Box.Position = Vector2.new(hrpVec.X - width/2, hrpVec.Y - height/2)
                        esp.Box.Color = TEAMCHECK_ENABLED and (plr.Team == LocalPlayer.Team and Color3.fromRGB(0, 150, 255) or Color3.fromRGB(255, 0, 0)) or Color3.fromRGB(255,255,255) -- Blue for team, red for enemy
                    end

                    -- ESP Line
                    if esp.Line and ESPLINE_ENABLED then
                        esp.Line.Visible = true
                        esp.Line.From = Vector2.new(Camera.ViewportSize.X/2, Camera.ViewportSize.Y) -- From bottom center of screen
                        esp.Line.To = hrpVec
                        esp.Line.Color = TEAMCHECK_ENABLED and (plr.Team == LocalPlayer.Team and Color3.fromRGB(0, 150, 255) or Color3.fromRGB(255, 0, 0)) or Color3.fromRGB(0,255,0)
                    else
                        if esp.Line then esp.Line.Visible = false end
                    end
                else
                    if esp.Box then esp.Box.Visible = false end
                    if esp.Line then esp.Line.Visible = false end
                end
            else
                -- If ESP is not enabled or not on screen, hide all visuals
                if esp.Box then esp.Box.Visible = false end
                if esp.Line then esp.Line.Visible = false end
            end
        else
            -- If player/character invalid, hide all visuals
            if esp.Box then esp.Box.Visible = false end
            if esp.Line then esp.Line.Visible = false end
        end
    end

    -- Aimbot execution (still needs to be fully implemented, this just gets the target)
    local target = getClosestToFOV()
    if AIMBOT_ENABLED and target then
        -- This is where your actual aimbot logic would go to move the mouse/camera
        -- Example (only works for client-side camera manipulation if allowed):
        -- local screenPos, onScreen = Camera:WorldToViewportPoint(target.Position)
        -- if onScreen then
        --     Mouse.X = screenPos.X
        --     Mouse.Y = screenPos.Y
        -- end
    end
end)

-- Toggle GUI with a keybind (e.g., LeftControl)
UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if input.KeyCode == Enum.KeyCode.LeftControl and not gameProcessed then
        if win.Panel then
            win.Panel.Visible = not win.Panel.Visible
            GUI_CLOSED = not win.Panel.Visible -- Update GUI_CLOSED state based on actual visibility
        end
    end
end)
