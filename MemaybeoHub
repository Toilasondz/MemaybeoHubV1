-- MeMayBeo - Sá»­a lá»—i & tá»‘i Æ°u cho Flick
-- YÃªu cáº§u: Rayfield + executor há»— trá»£ Drawing

-- 0. Delay nhá» Ä‘á»ƒ Rayfield load tá»‘t trÃªn mobile
task.wait(0.3)

-- 1. Khá»Ÿi táº¡o Rayfield (báº£n á»•n Ä‘á»‹nh)
local Rayfield = loadstring(game:HttpGet("https://raw.githubusercontent.com/shlexware/Rayfield/main/source"))()

-- 2. Services & globals
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")

local LocalPlayer = Players.LocalPlayer
local Camera = Workspace.CurrentCamera
local PlayerGui = LocalPlayer:WaitForChild("PlayerGui")

local AIMBOT_ENABLED = false
local ESP_ENABLED = false
local ESPLINE_ENABLED = false
local FOV_ENABLED = false
local TEAMCHECK_ENABLED = false

local ESPs = {}
local FOV_RADIUS = 90

-- Try create Drawing circle for FOV
local fovCircle
do
    local ok, c = pcall(function() return Drawing.new("Circle") end)
    if ok and c then
        fovCircle = c
        fovCircle.Visible = false
        fovCircle.Radius = FOV_RADIUS
        fovCircle.Thickness = 2
        fovCircle.Color = Color3.fromRGB(255,255,255)
        fovCircle.Filled = false
    else
        fovCircle = nil
    end
end

-- Helpers
local function showNotification(msg)
    pcall(function()
        Rayfield:Notify({
            Title = "MeMayBeo Hub",
            Content = msg,
            Duration = 3,
            Image = nil
        })
    end)
end

local function safeRemoveDrawing(obj)
    if not obj then return end
    pcall(function() obj:Remove() end)
end

-- Create ESP entry for player
local function createESP(plr)
    if not plr or plr == LocalPlayer then return end
    if ESPs[plr] then return end

    local ok1, box = pcall(function() return Drawing.new("Square") end)
    local ok2, line = pcall(function() return Drawing.new("Line") end)

    ESPs[plr] = {
        Box = ok1 and box or nil,
        Line = ok2 and line or nil
    }

    if ESPs[plr].Box then
        ESPs[plr].Box.Visible = false
        ESPs[plr].Box.Thickness = 1
        ESPs[plr].Box.Filled = false
    end
    if ESPs[plr].Line then
        ESPs[plr].Line.Visible = false
        ESPs[plr].Line.Thickness = 1
    end
end

-- Improved visibility check using RaycastParams
local function isVisible(part)
    if not part or not Camera then return false end
    local origin = Camera.CFrame.Position
    local direction = (part.Position - origin)
    local mag = direction.Magnitude
    if mag == 0 then return true end

    local params = RaycastParams.new()
    params.FilterDescendantsInstances = {LocalPlayer.Character}
    params.FilterType = Enum.RaycastFilterType.Blacklist
    params.IgnoreWater = true

    local result = Workspace:Raycast(origin, direction.Unit * math.clamp(mag, 0.1, 4000), params)
    if not result then
        return true
    end
    if result.Instance and part and result.Instance:IsDescendantOf(part.Parent) then
        return true
    end
    return false
end

-- Find closest valid target within FOV circle
local function getClosestToFOV()
    if not AIMBOT_ENABLED or not Camera then return nil end
    local center = Vector2.new(Camera.ViewportSize.X/2, Camera.ViewportSize.Y/2)
    local closestPart = nil
    local bestDist = math.huge

    for _, plr in pairs(Players:GetPlayers()) do
        if plr ~= LocalPlayer and plr.Character and plr.Character.Parent then
            local head = plr.Character:FindFirstChild("Head") or plr.Character:FindFirstChild("HumanoidRootPart")
            if head and head.Position then
                if TEAMCHECK_ENABLED then
                    if plr.Team and LocalPlayer.Team and plr.Team == LocalPlayer.Team then
                        continue
                    end
                end

                local vec = Camera:WorldToViewportPoint(head.Position)
                -- 'vec.Z > 0' indicates in front of camera
                if vec.Z > 0 then
                    local screenPos = Vector2.new(vec.X, vec.Y)
                    local mag = (screenPos - center).Magnitude
                    if mag <= (fovCircle and fovCircle.Radius or FOV_RADIUS) and mag < bestDist then
                        if isVisible(head) then
                            closestPart = head
                            bestDist = mag
                        end
                    end
                end
            end
        end
    end

    return closestPart
end

-- 4. Rayfield UI setup
local Window = Rayfield:CreateWindow{
    Name = "MeMayBeo",
    LoadingTitle = "MeMayBeo Hub",
    LoadingSubtitle = "by @hoangvanson_9k",
    ConfigurationSaving = { Enabled = false },
    Discord = { Enabled = false },
    KeySystem = false
}

local MainTab = Window:CreateTab("ðŸ  Home")
local MainSection = MainTab:CreateSection("Main")

-- Add a slider for aim smoothness
local aimSmooth = 0.35
MainSection:CreateSlider({
    Name = "Aim Smooth",
    Range = {0, 1},
    Increment = 0.05,
    Suffix = "",
    CurrentValue = aimSmooth,
    Flag = "aimSmooth",
    Callback = function(v)
        aimSmooth = v
    end
})

-- FOV radius slider
MainSection:CreateSlider({
    Name = "FOV Radius",
    Range = {20, 500},
    Increment = 5,
    Suffix = "px",
    CurrentValue = FOV_RADIUS,
    Flag = "fovRadius",
    Callback = function(v)
        FOV_RADIUS = v
        if fovCircle then fovCircle.Radius = v end
    end
})

-- Buttons / Toggles
MainSection:CreateToggle({
    Name = "Aimbot",
    CurrentValue = false,
    Flag = "aimToggle",
    Callback = function(val)
        AIMBOT_ENABLED = val
        showNotification(val and "Aimbot Báº¬T" or "Aimbot Táº®T")
    end
})

MainSection:CreateToggle({
    Name = "ESP",
    CurrentValue = false,
    Flag = "espToggle",
    Callback = function(val)
        ESP_ENABLED = val
    end
})

MainSection:CreateToggle({
    Name = "ESP Lines",
    CurrentValue = false,
    Flag = "espLineToggle",
    Callback = function(val)
        ESPLINE_ENABLED = val
    end
})

MainSection:CreateToggle({
    Name = "Show FOV",
    CurrentValue = false,
    Flag = "fovToggle",
    Callback = function(val)
        FOV_ENABLED = val
    end
})

MainSection:CreateToggle({
    Name = "Team Check",
    CurrentValue = false,
    Flag = "teamCheck",
    Callback = function(val)
        TEAMCHECK_ENABLED = val
    end
})

-- 5. Events: player join/leave and character handling
for _, p in ipairs(Players:GetPlayers()) do
    createESP(p)
end
Players.PlayerAdded:Connect(function(plr)
    createESP(plr)
end)

Players.PlayerRemoving:Connect(function(plr)
    local data = ESPs[plr]
    if data then
        safeRemoveDrawing(data.Box)
        safeRemoveDrawing(data.Line)
        ESPs[plr] = nil
    end
end)

LocalPlayer.CharacterAdded:Connect(function(char)
    task.wait(0.1)
    Camera = Workspace.CurrentCamera
end)

-- 6. ESP updater (lower frequency to reduce lag)
spawn(function()
    while true do
        if ESP_ENABLED and Camera then
            for plr, esp in pairs(ESPs) do
                if not plr or not plr.Character or not esp then
                    if esp and esp.Box then esp.Box.Visible = false end
                    if esp and esp.Line then esp.Line.Visible = false end
                    goto cont
                end

                local hrp = plr.Character:FindFirstChild("HumanoidRootPart") or plr.Character:FindFirstChild("UpperTorso") or plr.Character:FindFirstChild("Torso")
                if hrp and Camera then
                    local pos3 = hrp.Position
                    local top3 = pos3 + Vector3.new(0, 3.5, 0)
                    local bottom3 = pos3 - Vector3.new(0, 3.5, 0)
                    local topVec = Camera:WorldToViewportPoint(top3)
                    local bottomVec = Camera:WorldToViewportPoint(bottom3)
                    local vec = Camera:WorldToViewportPoint(pos3)
                    local onScreen = topVec.Z > 0 or bottomVec.Z > 0

                    local height = math.abs(topVec.Y - bottomVec.Y)
                    local width = height * 0.6
                    local espColor = (TEAMCHECK_ENABLED and plr.Team and LocalPlayer.Team and plr.Team == LocalPlayer.Team)
                        and Color3.fromRGB(0,255,0) or Color3.fromRGB(255,0,0)

                    if onScreen and ESP_ENABLED then
                        if esp.Box then
                            esp.Box.Size = Vector2.new(width, height)
                            esp.Box.Position = Vector2.new(vec.X - width/2, vec.Y - height/2)
                            esp.Box.Color = espColor
                            esp.Box.Visible = true
                        end
                    else
                        if esp.Box then esp.Box.Visible = false end
                    end

                    if onScreen and ESPLINE_ENABLED then
                        if esp.Line then
                            esp.Line.From = Vector2.new(Camera.ViewportSize.X/2, 0)
                            esp.Line.To = Vector2.new(vec.X, vec.Y)
                            esp.Line.Color = espColor
                            esp.Line.Visible = true
                        end
                    else
                        if esp.Line then esp.Line.Visible = false end
                    end
                else
                    if esp.Box then esp.Box.Visible = false end
                    if esp.Line then esp.Line.Visible = false end
                end

                ::cont::
            end
        else
            -- hide all
            for _, esp in pairs(ESPs) do
                if esp.Box then esp.Box.Visible = false end
                if esp.Line then esp.Line.Visible = false end
            end
        end

        task.wait(0.08) -- ~12.5 FPS updates for ESP
    end
end)

-- 7. Render loop for smooth aim & FOV
RunService.RenderStepped:Connect(function(delta)
    Camera = Workspace.CurrentCamera

    -- Update FOV circle quickly
    if fovCircle then
        if FOV_ENABLED and Camera then
            fovCircle.Position = Vector2.new(Camera.ViewportSize.X/2, Camera.ViewportSize.Y/2)
            fovCircle.Visible = true
        else
            fovCircle.Visible = false
        end
    end

    -- Smooth aimbot
    if AIMBOT_ENABLED and Camera then
        local targetPart = getClosestToFOV()
        if targetPart and targetPart.Position then
            local camPos = Camera.CFrame.Position
            local desired = CFrame.new(camPos, targetPart.Position)
            local alpha = aimSmooth -- from slider
            -- scale by frame delta to keep consistent across FPS
            Camera.CFrame = Camera.CFrame:lerp(desired, math.clamp(alpha * (delta * 60), 0, 1))
        end
    end
end)

-- 8. Cleanup
local function cleanupAll()
    if fovCircle then
        pcall(function() fovCircle:Remove() end)
        fovCircle = nil
    end
    for plr, data in pairs(ESPs) do
        safeRemoveDrawing(data.Box)
        safeRemoveDrawing(data.Line)
        ESPs[plr] = nil
    end
end

_G.MeMayBeo_Cleanup = cleanupAll

-- End
